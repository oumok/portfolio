// Parse projects data from inline JSON
const projectsData = JSON.parse(document.getElementById('projects-data').textContent);

const grids = {
  architecture: document.getElementById('architecture-grid'),
  production: document.getElementById('production-grid'),
  product: document.getElementById('product-grid')
};

// Utility to create project thumbnail
function createProjectCard(project, category) {
  const card = document.createElement('div');
  card.className = 'project-card';
  card.innerHTML = `
    <img src="${project.thumbnail}" alt="${project.title}" />
    <h3>${project.title}</h3>
  `;

  card.addEventListener('click', () => openProjectModal(project));
  grids[category].appendChild(card);
}

// Load projects into their respective grids
Object.keys(projectsData).forEach(cat => {
  projectsData[cat].forEach(proj => createProjectCard(proj, cat));
});

// Modal elements
const modal = document.getElementById('project-modal');
const modalClose = document.getElementById('modal-close');
const modalTitle = document.getElementById('modal-title');
const modalDesc = document.getElementById('modal-description');
const modalDetails = document.getElementById('modal-details');
const modalGallery = document.getElementById('modal-gallery');

// Tab buttons (will be dynamically created)
let tabButtons = [];

// Open modal with tabs
function openProjectModal(project) {
  modalTitle.textContent = project.title;
  modalDesc.textContent = project.description;
  modalGallery.innerHTML = '';
  modalDetails.innerHTML = '';

  // Clear previous tabs
  const existingTabs = modal.querySelector('.tabs');
  if (existingTabs) existingTabs.remove();

  // Create tab buttons container
  const tabsContainer = document.createElement('div');
  tabsContainer.className = 'tabs';

  // Prepare tabs
  const tabs = [];

  if (project.livePhotos && project.livePhotos.length) {
    tabs.push({ name: 'Real-life Photos', key: 'livePhotos' });
  }
  if (project.gallery && project.gallery.length) {
    tabs.push({ name: 'Renders / Plans', key: 'gallery' });
  }
  if (project.images && project.images.length) {
    tabs.push({ name: 'Gallery', key: 'images' }); // fallback for production/product
  }

  // Create tab buttons
  tabButtons = tabs.map((tab, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.textContent = tab.name;
    if (idx === 0) btn.classList.add('active');
    btn.addEventListener('click', () => showTab(tab.key, btn));
    tabsContainer.appendChild(btn);
    return btn;
  });

  modalGallery.parentNode.insertBefore(tabsContainer, modalGallery);

  // Show first tab by default
  if (tabs[0]) showTab(tabs[0].key, tabButtons[0]);

  modal.style.display = 'block';
}

// Show selected tab
function showTab(key, activeBtn) {
  // Update active button
  tabButtons.forEach(btn => btn.classList.remove('active'));
  activeBtn.classList.add('active');

  // Clear gallery
  modalGallery.innerHTML = '';

  // Get the correct array
  let imagesArray = [];
  if (key === 'livePhotos') imagesArray = activeProject.livePhotos || [];
  else if (key === 'gallery') imagesArray = activeProject.gallery || [];
  else if (key === 'images') imagesArray = activeProject.images?.map(src => ({ src })) || [];

  // Populate gallery
  imagesArray.forEach(img => {
    const imgEl = document.createElement('img');
    imgEl.src = img.src;
    if (img.caption) imgEl.alt = img.caption;
    modalGallery.appendChild(imgEl);

    // Click to open lightbox
    imgEl.addEventListener('click', () => openLightbox(img.src, img.caption || ''));
  });
}

// Close modal
modalClose.addEventListener('click', () => {
  modal.style.display = 'none';
});

// Keep track of current project for tabs
let activeProject = null;
function openProjectModal(project) {
  activeProject = project;
  modalTitle.textContent = project.title;
  modalDesc.textContent = project.description;
  modalGallery.innerHTML = '';
  modalDetails.innerHTML = '';

  // Remove existing tabs if any
  const oldTabs = modal.querySelector('.tabs');
  if (oldTabs) oldTabs.remove();

  // Create tabs
  const tabsContainer = document.createElement('div');
  tabsContainer.className = 'tabs';
  modalGallery.parentNode.insertBefore(tabsContainer, modalGallery);

  const tabs = [];
  if (project.livePhotos?.length) tabs.push({ name: 'Real-life Photos', key: 'livePhotos' });
  if (project.gallery?.length) tabs.push({ name: 'Renders / Plans', key: 'gallery' });
  if (project.images?.length) tabs.push({ name: 'Gallery', key: 'images' });

  tabButtons = tabs.map((tab, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.textContent = tab.name;
    if (idx === 0) btn.classList.add('active');
    btn.addEventListener('click', () => showTab(tab.key, btn));
    tabsContainer.appendChild(btn);
    return btn;
  });

  if (tabs[0]) showTab(tabs[0].key, tabButtons[0]);

  modal.style.display = 'block';
}

// Lightbox logic (simple)
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxCaption = document.getElementById('lightbox-caption');
const lightboxClose = document.getElementById('lightbox-close');

function openLightbox(src, caption = '') {
  lightboxImg.src = src;
  lightboxCaption.textContent = caption;
  lightbox.style.display = 'block';
}
lightboxClose.addEventListener('click', () => lightbox.style.display = 'none');
